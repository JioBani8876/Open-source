## 3. 시스템 설계

### 3.1. 전체 시스템 구조


#### 3.1.1. 전체 시스템 구조

![전체 설계](.\image\전체 설계.png)

#### 3.1.2. 데이터 베이스 및 데이터 모델

- 계정 DB : 아이디 비밀번호 등의 사용자의 개인 정보와 선호도 등의 정보를 저장하는 DB
- 음원 정보 DB : 음원 태그 데이터와 음원 정보(가사, 아티스트)를 저장하는 DB
- 음원 파일 DB : mp3,flac등 음원 파일 자체를 저장하는 DB
- 학습데이터 DB : 기계학습을 위한 학습 데이터를 저장하는 DB

#### 3.1.3. 파트별 설명 및 기능

- **Flutter 애플리케이션(사용자)** 
  - 사용자의 디바이스에서 동작하는 사용자와 통신하기 위한 애플리케이션
  - 앱 제작 오픈소스 프레임워크인 **Flutter**로 제작

- **음악 검색 및 추천 시스템**
  - **Flutter 애플리케이션**으로 부터 음악 추천 요청을 받아 다시 **앱**으로 추천 음악 데이터를 전송
- **음악 태그 데이터 학습**
  - 다양한 방법으로 데이터를 수집해 기계학습을 통해 음악(muid)을 키로하는 태그 데이터를 생성하고 **음악 검색 및 추천 시스템**으로 갱신된 데이터를 전송
- **계정 정보 관리**
  - 로그인, 회원가입, 프로필 데이터 관리등 일반적인 계정 정보와 좋아요 등의 프로필 정보를 관리하고 **앱**과 계정과 관련된 통신을 담당



### 3.2. 상세 설계

#### 3.2.1. 음악 검색 및 추천

- **음악 검색 및 추천 시스템**은 **Flutter 애플리케이션**으로 부터 음악 추천 요청을 받아 음원 정보 DB에서 태그 기반으로 검색해 결과를 다시 **앱**으로 전송한다.

##### DFD

- ![image-20221202102913090](.\image\음악 검색 및 추천 파트.png)

- 날씨에 따른 음악 추천, 장소에 따른 음악 추천등의 모든 음악 추천 요청은 **애플리케이션 음악 요청**으로 표현

- **음원 정보 DB**에서 검색 : **음악 검색 API**에서 태그를 포함한 음악 요청을 받아 태그를 기반으로 음악을 검색하여 muid를 포함한 음원 정보 데이터 객체의 리스트를 **음악 검색 API**에 돌려줌

- **음악 검색 API**에서 추천한 음악 추천 리스트는 추천 재생목록등의 기능에 쓰이기 위해 **애플리케이션**으로 이동하고, 음악 스트리밍시에 muid를 **음원 요청 API**에 입력해 **음원 파일 DB**로 부터 음원 파일을 다운로드

  

##### 	API 설명 및 입출력

- **오픈소스** 
  
  - Geolocator
    - 기능 : Flutter 프레임 워크 안에서 디바이스의 GPS 서비스와 통신하는 라이브러리
    - 입력 : 좌표 요청(Flutter 에서 함수 호출)
    - 출력 : 좌표(위도 경도)
  - 기상청 단기 예보 중 초단기 실황 정보
    - 기능 : 예보 구역에 대한 대표 AWS 관측값 제공. 현재 날씨 데이터를 받아오기 위해 초단기 예보 사용
    - 입력 : 좌표를 포함한 초단기 예보 요청 객체
    - 출력 : 날씨 데이터 객체
  - Emotion - recognition 
    - 기능 : 사진이나 영상을 분석해 사진 속 인물의 복합적인 감정의 비율을 출력
    - 입력 : 사진
    - 출력 : 감정과 그 확률을 쌍으로 하는 배열
  - Elastic Search
    - 기능 : 오타 수정, 동의어 처리, 데이터 집계 및 분석등 자연어로 이루어진 검색어 처리를 위한 다양한 기능 제공
    - 입력 : 검색어
    - 출력 : 검색어 분석 결과
  - Places API
    - 기능 : 구글 맵 플랫폼으로 여러 입력을 장소로 변환하는 기능을 포함해 특정 장소에 대한 정보, 관련된 검색어 자동완성, 추천 기능등 지역 및 장소에 대한 다양한 기능을 제공. 여기서는 좌표를 장소 유형과 세부 정보를 가져오는 기능을 사용
      - 좌표를 통해 국가, 지역, 건물, 장소, 장소 유형등의 정보를 얻어 **음악 검색 및 추천 서버**로 전송함
    - 입력 : 좌표
    - 출력 : 시설, 시리적 위치 및 주요 관심 장소에 대한 정보
  
- **자체 개발 API**
  
  - 날씨 통신 API
    - 기능 : **애플리케이션**의 요청에 따라 **Geolocator**에서 좌표를 요청하고 이를 바탕으로 요청 객체를 제작하고 **기상청 단기예보 API**에 초단기 실황을 요청함. 또한 받은 날씨 데이터를 **음악 검색 및 추천 서버**으로 전송
    - 입력 : 좌표
    - 출력 : 좌표를 포함한 초단기예보 요청 객체
  
  - 음악 검색 API
    - 기능 : **애플리케이션**의 다양한 음악 추천 및 검색 요청을 정리하고 음악 데이터를 **애플리케이션**에 다시 전송
      - 감정 해석 텍스트, 검색어 분석 결과, 날씨, 장소 등 다양한 형태의 요청 데이터를 **음악 태그 데이터 DB**의 데이터를 태그 기반으로 검색하기 위해 일정한 **검색 객체**로 변환함
    - 음악 검색
      - 입력 : 감정 해석 텍스트, 검색어 분석 결과, 좌표 , 국가, 장소, 날씨 등 다양한 요청 정보
      - 출력 : 태그를 포함한 일정한 검색 객체
    - 음악 데이터 전송 : **음악 데이터 DB**로 부터 받은 데이터를 요청한 사용자 **애플리케이션**에 전송
  
  - 음원 요청 API
    - 기능 : 음원 파일을  **음원 DB**에 요청하고 **사용자 디바이스**에 스트리밍을 위해 다운로드
    - 입력 : muid
    - 출력 : 음원 파일(flac , mp3 등)
    
    

#### 3.2.2. 음악 데이터 제작 및 학습 

##### **DFD**

![image-20221203115430874](C:/Users/늑향/OneDrive/문서/대학/2학년 2학기/오픈소스소프트웨어/과제/보고서/시스템 설계/image/태그 데이터 학습 파트.png)

- **기계 학습 데이터 생성 API**는 여러 API를 통해 얻은 데이터 출력을 통일시키고 학습 데이터 DB에 축적시킨다. 축적된 데이터는 **기계 학습 클라우드 서버에** 전송되어 학습을 진행하고, 완료된 데이터는 **음원정보 DB**로 전달되어 태그 정보를 업데이트시킨다.
- 콜드 스타트 : 신규 혹은 사용한지 얼마 되지 않은 정보가 부족한 사용자에게 어떤 컨텐츠를 추천할 것인지에 대한 문제
  - 회원 가입시 나이, 성별 등의 기본 정보 입력을 통해 기본적인 정보를 얻어 사용자 정보 기반 추천에 사용한다. 그 후 로그인을 한 후, 사용자와 비슷한 특징을 가진 모집단의 추천을 통하여 음악을 제공한다. 사용자의 현재 위치한 장소나 날씨를 기반으로, 또는 연령과 성별 등의 개인 정보로 나뉘는 모집단이 즐겨 듣는 노래가 있는지, 판단하는 것이다. 
  - 서비스에서 최초 회원 정보와 장소, 감정을 통한 추천이 이루어지므로, 콜드스타트로부터 비교적 자유로울 수 있다.
  - 크롤링을 이용한 외부 데이터 학습과 music auto tagger를 통한 음원 자체 분석이 이루어 지므로 사용자 데이터 축적 없이 음악을 추천 할 수 있다



##### **API 설명 및 입출력**

- **오픈소스**
  - Scrapy

    - 기능 : 여러 사이트의 인기차트 목록, 음악의 인터넷 상 검색 기록, 평가 등의 정보 수집

    - 입력 : 사이트의 URL

    - 출력 : 차트 리스트, 관련 검색된 단어 

    - 지니, 벅스 등의 음원 스트리밍 서비스 외에도 국내의 노래방 인기차트, 해외의 빌보드 등 여러 차트 정보의 URL을 통해 인기차트 목록을 추출한다. 여러 음악 평론이나 가수, 작곡가 등의 정보 또한 수집한다.
  - music auto tagger

    - 기능 : 곡의 주파수 데시벨 등을 분석하여 알맞는 장르의 태깅

    - 입력 : 음원 파일 ( .mp3 )
    - 출력 : 분류된 장르와 그 확률값을 나타내는 실수 벡터
    - 장르, 가사, 반주에 사용되는 악기, 곡의 주파수와 데시벨 등을 분석하여 특징을 찾아내고, 관련된 장르와 그에 가까운 값을 실수와 함께 나타내어 출력한다. 

- **자체 개발 API**
  - 기계 학습 데이터 생성 API
    - 기능 : 입력 받은 데이터 정리 및 **학습 DB**에 전달
    - 입력 : 리스트, 음원 벡터
    - 출력 : 학습 데이터

 

#### 3.2.3. 계정 관리

##### **DFD**

![image-20221201172517038](.\image\계정 파트.png)

- 계정 DB는 사용자 디바이스로 추천되는 음악과 선호도를 저장하고, 학습 서버에 선호도를 전달한다. 

##### **API 설명 및 입출력**

- **자체 제작 API**
  - 계정 API
    - 기능 : 서비스의 서버와 계정 DB간 통신 및 회원 관리
      - 최초 사용자의 회원가입, 로그인, 개인의 선호도 등이 포함된 **계정 DB**와 **애플리케이션**의 통신 등
    - 입력 : 사용자 정보 요청
    - 출력 : 사용자 정보 반환

